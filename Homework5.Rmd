---
title: "Homework 5, Amelia Grant-Alfieri, ag3911"
output: github_document
---

# Problem 1

## Tidy Data
Tidy dataframe should include data from all participants, including the subject ID, arm, and observations over time:
```{r message=FALSE}
library(tidyverse)
library(dplyr)
library(tidyr)
library(purrr)
library(readr)
library(data.table)
getwd()

csv_files = list.files(path = ".", pattern = "*.csv")
csv_files
p1 = csv_files %>%
  map(read_csv) %>%
  janitor::clean_names() %>%
  reduce(rbind) %>%
  mutate(arm = 1:20) %>%
  mutate(ID = 1:20) %>%
  mutate(arm = as.character(arm)) %>%
  mutate(arm = if_else(arm == 1:10, "con", "exp")) %>%
  gather(key = week, value = "observation", week_1:week_8) %>%
  separate(week, into = c("delete", "week"), sep = "_") %>%  
  select(-delete) 
```

## Plot observations of each subject over time 
Make a spaghetti plot showing observations on each subject over time, and comment on differences between groups.
```{r}
library(ggplot2)
p1 %>%
  ggplot(aes(x = week, y = observation, group = ID, color = ID)) + geom_line() + labs(title = "Subject Observations over Eight Weeks", color = "Subject ID") + scale_color_gradientn(colours = rainbow(5))
```


# Problem 2

## Tidy Data

The raw data includes the following information: the case ID number; the date of the homicide; the victim's first name, last name, race, and sex; the location of the homicide by city, state, latitude, and longitude; and the disposition (open/no arrest, closed by arrest, closed without arrest).  
Create a city_state variable (e.g. “Baltimore, MD”). 
```{r message=FALSE}
library(tidyverse)
library(rvest)
library(httr)
library(tidyr)
library(stringr)
library(dplyr)

getwd()
tidy = read_csv("./homicide-data.csv") %>%
  mutate(city_state = str_c(city, ", ", state))
```

Summarize within cities to obtain the total number of homicides and the number of unsolved homicides (those for which the disposition is “Closed without arrest” or “Open/No arrest”).

```{r}
#Total number of homicides per city
total = tidy %>%
  group_by(city_state) %>%
  summarise(n = n())

#Number of unsolved homicides per city
unsolved = tidy %>%
  filter(disposition == "Closed without arrest" | disposition == "Open/No arrest") %>%
  group_by(city_state) %>%
  summarise(n = n())

joined = inner_join(unsolved, total, by = "city_state")
```

## Estimate proportion of unsolved homicides in Baltimore, MD
```{r}
baltimore = filter(joined, joined$city_state == "Baltimore, MD") 
prop_unsolv_baltimore = prop.test(baltimore$n.x, baltimore$n.y) %>%
  broom::tidy(prop_unsolv_baltimore) %>%
  select(estimate, conf.low, conf.high)
```

## Estimate proportion of unsolved homicides in each city 
* run prop.test for each of the cities in your dataset
* extract both the proportion of unsolved homicides and the confidence interval for each
* Do this within a “tidy” pipeline, making use of purrr::map, purrr::map2
* list columns and unnest as necessary to create a tidy dataframe with estimated proportions and CIs for each city.

```{r}
library(purrr)
library(tidyverse)

all_city_prop = joined %>%
  mutate(output = map2(.x = n.x, .y = n.y, ~prop.test(.x, .y))) %>%
  broom::tidy(prop_unsolv_baltimore) %>%
  select(estimate, conf.low, conf.high)
pull = all_city_prop %>% 
  pull(output) %>%    #this pulls out estimates, confidence intervals, etc..

  

#ikd what to do after this point....

delist = function(df) {
  lm(conf.int, all_city_prop = df) 
}

new = all_city_prop %>%
  mutate(estimate_conf = map(output, delist))

map(all_city_prop$output, ~lm(estimate ~ conf.int, output = .x))

all_city
```


## Plot estimate and confidence interval for each city's proportion of unsolved homicides
Create a plot that shows the estimates and CIs for each city
* check out  geom_errorbar for a way to add error bars based on the upper and lower limits
* Organize cities according to the proportion of unsolved homicides.

```{r}

```


